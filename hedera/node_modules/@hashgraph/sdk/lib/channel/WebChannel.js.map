{"version":3,"file":"WebChannel.js","sources":["../../src/channel/WebChannel.js"],"sourcesContent":["// SPDX-License-Identifier: Apache-2.0\nimport { ALL_WEB_NETWORK_NODES } from \"../constants/ClientConstants.js\";\nimport GrpcServiceError from \"../grpc/GrpcServiceError.js\";\nimport GrpcStatus from \"../grpc/GrpcStatus.js\";\nimport HttpError from \"../http/HttpError.js\";\nimport HttpStatus from \"../http/HttpStatus.js\";\nimport { SDK_VERSION } from \"../version.js\";\nimport Channel, { encodeRequest, decodeUnaryResponse } from \"./Channel.js\";\n\nexport default class WebChannel extends Channel {\n    /**\n     * @param {string} address\n     */\n    constructor(address) {\n        super();\n\n        /**\n         * @type {string}\n         * @private\n         */\n        this._address = address;\n    }\n\n    /**\n     * @override\n     * @returns {void}\n     */\n    close() {\n        // do nothing\n    }\n\n    /**\n     * @override\n     * @protected\n     * @param {string} serviceName\n     * @returns {import(\"protobufjs\").RPCImpl}\n     */\n    _createUnaryClient(serviceName) {\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        return async (method, requestData, callback) => {\n            try {\n                // this will be executed in a browser environment so eslint is\n                // disabled for the fetch call\n                //eslint-disable-next-line n/no-unsupported-features/node-builtins\n                const response = await fetch(\n                    `${this._address}/proto.${serviceName}/${method.name}`,\n                    {\n                        method: \"POST\",\n                        headers: {\n                            \"content-type\": \"application/grpc-web+proto\",\n                            \"x-user-agent\": SDK_VERSION,\n                            \"x-grpc-web\": \"1\",\n                        },\n                        body: encodeRequest(requestData),\n                    },\n                );\n\n                if (!response.ok) {\n                    const error = new HttpError(\n                        HttpStatus._fromValue(response.status),\n                    );\n                    callback(error, null);\n                }\n\n                // Check headers for gRPC errors\n                const grpcStatus = response.headers.get(\"grpc-status\");\n                const grpcMessage = response.headers.get(\"grpc-message\");\n\n                if (grpcStatus != null && grpcMessage != null) {\n                    const error = new GrpcServiceError(\n                        GrpcStatus._fromValue(parseInt(grpcStatus)),\n                        ALL_WEB_NETWORK_NODES[this._address].toString(),\n                    );\n                    error.message = grpcMessage;\n                    callback(error, null);\n                }\n\n                const responseBuffer = await response.arrayBuffer();\n                const unaryResponse = decodeUnaryResponse(responseBuffer);\n\n                callback(null, unaryResponse);\n            } catch (error) {\n                const err = new GrpcServiceError(\n                    // retry on grpc web errors\n                    GrpcStatus._fromValue(18),\n                    ALL_WEB_NETWORK_NODES[this._address].toString(),\n                );\n                callback(err, null);\n            }\n        };\n    }\n}\n"],"names":["WebChannel","Channel","constructor","address","super","this","_address","close","_createUnaryClient","serviceName","async","method","requestData","callback","response","fetch","name","headers","SDK_VERSION","body","encodeRequest","ok","HttpError","HttpStatus","_fromValue","status","grpcStatus","get","grpcMessage","error","GrpcServiceError","GrpcStatus","parseInt","ALL_WEB_NETWORK_NODES","toString","message","responseBuffer","arrayBuffer","decodeUnaryResponse"],"mappings":"sVASe,MAAMA,UAAmBC,EAIpC,WAAAC,CAAYC,GACRC,QAMAC,KAAKC,SAAWH,CACxB,CAMI,KAAAI,GAEJ,CAQI,kBAAAC,CAAmBC,GAEf,OAAOC,MAAOC,EAAQC,EAAaC,KAC/B,IAII,MAAMC,QAAiBC,MACnB,GAAGV,KAAKC,kBAAkBG,KAAeE,EAAOK,OAChD,CACIL,OAAQ,OACRM,QAAS,CACL,eAAgB,6BAChB,eAAgBC,EAChB,aAAc,KAElBC,KAAMC,EAAcR,KAI5B,IAAKE,EAASO,GAAI,CAIdR,EAHc,IAAIS,EACdC,EAAWC,WAAWV,EAASW,SAEnB,KACpC,CAGgB,MAAMC,EAAaZ,EAASG,QAAQU,IAAI,eAClCC,EAAcd,EAASG,QAAQU,IAAI,gBAEzC,GAAkB,MAAdD,GAAqC,MAAfE,EAAqB,CAC3C,MAAMC,EAAQ,IAAIC,EACdC,EAAWP,WAAWQ,SAASN,IAC/BO,EAAsB5B,KAAKC,UAAU4B,YAEzCL,EAAMM,QAAUP,EAChBf,EAASgB,EAAO,KACpC,CAEgB,MAAMO,QAAuBtB,EAASuB,cAGtCxB,EAAS,KAFayB,EAAoBF,GAG7C,CAAC,MAAOP,GAMLhB,EALY,IAAIiB,EAEZC,EAAWP,WAAW,IACtBS,EAAsB5B,KAAKC,UAAU4B,YAE3B,KAC9B,EAEA"}